# Use OpenJDK 17 as base image
FROM openjdk:17-jdk-slim

# Set working directory
WORKDIR /app

# Install Maven
RUN apt-get update && \
    apt-get install -y maven curl && \
    rm -rf /var/lib/apt/lists/*

# Copy Maven configuration files
COPY pom.xml .
COPY src ./src
COPY testdata ./testdata

# Create directories for reports and logs
RUN mkdir -p reports logs allure-results

# Download dependencies (this will be cached if pom.xml doesn't change)
RUN mvn dependency:resolve

# Copy test configuration files
COPY src/main/resources/*.properties src/main/resources/
COPY *.xml .

# Set environment variables
ENV MAVEN_OPTS="-Xmx1024m -XX:MaxPermSize=256m"
ENV JAVA_OPTS="-Xmx2048m -Xms1024m"

# Expose port for debugging (optional)
EXPOSE 5005

# Default command to run tests
CMD ["mvn", "clean", "test", "-Dsuite=testng.xml"]

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1